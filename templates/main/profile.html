{% extends 'base.html' %}
{% load math_filters %}

{% block title %}Личный кабинет - MatchMaker{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-4">
        <!-- Карточка профиля -->
        <div class="card mb-4 animate__animated animate__fadeInLeft profile-main-card">
            <div class="card-body text-center">
                <div class="mb-3 profile-avatar">
                    <div class="avatar-wrapper">
                        <i class="fas fa-user-circle" style="font-size: 5rem; color: #667eea;"></i>
                        <div class="status-indicator online"></div>
                    </div>
                </div>
                <h3 class="username-title">{{ user.username }}</h3>
                <p class="text-muted mb-1">{{ user.email }}</p>
                {% if user.social_url %}
                <p class="mb-2">
                    <a href="{{ user.social_url }}" target="_blank" rel="noopener" class="btn btn-sm btn-outline-primary">
                        <i class="fab fa-vk"></i> Профиль в соцсети
                    </a>
                </p>
                {% endif %}
                <small class="text-muted">
                    <i class="fas fa-calendar-alt"></i> 
                    Регистрация: {{ user.created_at|date:"d.m.Y" }}
                </small>
                
                <div class="mt-4 test-score-section">
                    <h5><i class="fas fa-brain me-2"></i>Психологический профиль</h5>
                    <div class="test-score-display">
                        <div class="score-circle">
                            <span id="total-score">{{ test_score }}</span>
                            <span class="score-max">/25</span>
                        </div>
                        <div class="score-description">
                            <span id="personality-badge" class="badge 
                                {% if test_score <= 10 %}bg-info{% elif test_score <= 15 %}bg-warning{% elif test_score <= 20 %}bg-success{% else %}bg-primary{% endif %}">
                                {% if test_score <= 10 %}Интроверт{% elif test_score <= 15 %}Сбалансированный{% elif test_score <= 20 %}Общительный{% else %}Экстраверт{% endif %}
                            </span>
                        </div>
                    </div>
                    <div class="progress mt-3" style="height: 12px;">
                        <div id="total-progress" class="progress-bar progress-bar-animated" role="progressbar" 
                             data-width="{{ test_score|mul:4 }}" style="background: var(--primary-gradient);">
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 d-grid gap-2">
                    <a href="{% url 'search' %}" class="btn btn-gradient btn-lg pulse-btn">
                        <i class="fas fa-search"></i> Найти собеседника
                    </a>
                    <button class="btn btn-outline-secondary btn-sm" 
                            data-bs-toggle="modal" data-bs-target="#profileStatsModal">
                        <i class="fas fa-chart-pie"></i> Подробная статистика
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Последние чаты -->
        {% if chats %}
        <div class="card animate__animated animate__fadeInLeft">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-comments"></i> Последние чаты</h5>
            </div>
            <div class="list-group list-group-flush">
                {% for chat in chats %}
                <a href="{% url 'chat' chat.id %}" class="list-group-item list-group-item-action">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ chat.get_other_user.username }}</strong>
                            <small class="text-muted d-block">
                                {{ chat.created_at|date:"d.m.Y H:i" }}
                            </small>
                        </div>
                        <i class="fas fa-chevron-right text-muted"></i>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="col-md-8">
        <!-- Интересы -->
        <div class="card mb-4 animate__animated animate__fadeInRight">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-heart"></i> Мои интересы</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    {% for interest in user.interests.all %}
                    <span class="interest-badge">
                        <i class="{{ interest.icon }}"></i> {{ interest.name }}
                    </span>
                    {% empty %}
                    <p class="text-muted">Интересы не выбраны</p>
                    {% endfor %}
                </div>
                
                <!-- Форма обновления интересов -->
                <button class="btn btn-sm btn-secondary-gradient" 
                        data-bs-toggle="collapse" data-bs-target="#updateInterests">
                    <i class="fas fa-edit"></i> Изменить интересы
                </button>
                
                <div class="collapse mt-3" id="updateInterests">
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="update_interests" value="1">

                        <!-- Панель управления интересами -->
                        <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
                            <div class="input-group" style="max-width: 360px;">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input id="interestSearch" type="search" class="form-control" placeholder="Поиск интересов">
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnSelectAll">
                                <i class="fas fa-check-double"></i> Выбрать все
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnClearAll">
                                <i class="fas fa-eraser"></i> Сбросить
                            </button>
                            <div class="ms-auto d-flex align-items-center gap-2">
                                <span class="badge bg-primary">Выбрано: <span id="selectedCount">0</span></span>
                                <span class="badge bg-secondary d-none" id="filterBadge">Фильтр: <span id="filterText"></span></span>
                            </div>
                        </div>

                        <div class="interests-container mb-3" id="interestsGrid">
                            <div class="row">
                                {% for choice in form.interests %}
                                <div class="col-md-6 col-lg-4 mb-2">
                                    <div class="form-check interest-item interest-filterable" data-name="{{ choice.choice_label|lower }}">
                                        {{ choice.tag }}
                                        <label class="form-check-label w-100" for="{{ choice.id_for_label }}">
                                            <i class="fas fa-star me-2"></i>{{ choice.choice_label }}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        

                        
                        <button type="submit" class="btn btn-gradient" id="save-interests-btn" disabled>
                            <i class="fas fa-save"></i> Сохранить интересы
                        </button>
                        <small class="text-muted ms-2" id="interests-help">Выберите минимум 3 интереса</small>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Психологический тест -->
        <div class="card animate__animated animate__fadeInRight">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-brain"></i> Психологический профиль</h5>
            </div>
            <div class="card-body">
                <div class="personality-traits">
                    <div class="trait-item mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="trait-label">
                                <i class="fas fa-users text-primary me-2"></i>
                                <span class="fw-bold">Общительность</span>
                            </label>
                            <span id="score-1" class="trait-score">{{ user.question1 }}/5</span>
                        </div>
                        <div class="custom-progress">
                            <div id="progress-1" class="progress-fill sociability" 
                                 data-width="{{ user.question1|mul:20 }}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="trait-item mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="trait-label">
                                <i class="fas fa-lightbulb text-warning me-2"></i>
                                <span class="fw-bold">Открытость новому</span>
                            </label>
                            <span id="score-2" class="trait-score">{{ user.question2 }}/5</span>
                        </div>
                        <div class="custom-progress">
                            <div id="progress-2" class="progress-fill openness" 
                                 data-width="{{ user.question2|mul:20 }}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="trait-item mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="trait-label">
                                <i class="fas fa-heart text-danger me-2"></i>
                                <span class="fw-bold">Эмоциональность</span>
                            </label>
                            <span id="score-3" class="trait-score">{{ user.question3 }}/5</span>
                        </div>
                        <div class="custom-progress">
                            <div id="progress-3" class="progress-fill emotionality" 
                                 data-width="{{ user.question3|mul:20 }}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="trait-item mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="trait-label">
                                <i class="fas fa-tasks text-success me-2"></i>
                                <span class="fw-bold">Организованность</span>
                            </label>
                            <span id="score-4" class="trait-score">{{ user.question4 }}/5</span>
                        </div>
                        <div class="custom-progress">
                            <div id="progress-4" class="progress-fill organization" 
                                 data-width="{{ user.question4|mul:20 }}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="trait-item mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="trait-label">
                                <i class="fas fa-handshake text-info me-2"></i>
                                <span class="fw-bold">Доброжелательность</span>
                            </label>
                            <span id="score-5" class="trait-score">{{ user.question5 }}/5</span>
                        </div>
                        <div class="custom-progress">
                            <div id="progress-5" class="progress-fill agreeableness" 
                                 data-width="{{ user.question5|mul:20 }}">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Форма перепрохождения теста -->
                <button class="btn btn-sm btn-secondary-gradient mt-3" 
                        data-bs-toggle="collapse" data-bs-target="#retakeTest">
                    <i class="fas fa-redo"></i> Перепройти тест
                </button>
                
                 <div class="collapse mt-3" id="retakeTest">
                     <form id="test-form" method="post">
                         {% csrf_token %}
                         <input type="hidden" name="update_test" value="1">
                         
                         <div class="test-questions">
                             {% for field in test_form %}
                             <div class="mb-4">
                                 <label class="form-label fw-bold" for="{{ field.id_for_label }}">
                                     {{ field.label }}
                                     <span class="badge bg-primary ms-2" id="val_{{ field.name }}">{{ field.value|default:3 }}</span>
                                 </label>
                                 <small class="text-muted d-block mb-2">{{ field.help_text }}</small>
                                 {{ field }}
                             </div>
                             {% endfor %}
                         </div>
                         
                         <button type="submit" class="btn btn-gradient" id="save-test-btn">
                             <i class="fas fa-save"></i> Сохранить результаты
                         </button>
                         <div id="test-save-status" class="mt-2"></div>
                     </form>
                 </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно со статистикой -->
<div class="modal fade" id="profileStatsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-pie me-2"></i>Подробная статистика профиля
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="stat-card">
                            <i class="fas fa-calendar-check stat-icon"></i>
                            <h6>Дней с регистрации</h6>
                            <p class="stat-value">{{ user.created_at|timesince }}</p>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="stat-card">
                            <i class="fas fa-heart stat-icon"></i>
                            <h6>Интересов выбрано</h6>
                            <p class="stat-value">{{ user.interests.count }}</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="stat-card">
                            <i class="fas fa-trophy stat-icon"></i>
                            <h6>Балл совместимости</h6>
                            <p class="stat-value">{{ test_score|mul:4 }}%</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6><i class="fas fa-chart-bar me-2"></i>Личностные черты</h6>
                    <div class="personality-radar">
                        <canvas id="personalityChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Профиль карточка */
    .profile-main-card {
        background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.95) 100%);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.18);
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }
    
    .avatar-wrapper {
        position: relative;
        display: inline-block;
    }
    
    .status-indicator {
        position: absolute;
        bottom: 10px;
        right: 10px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 3px solid white;
    }
    
    .status-indicator.online {
        background: #28a745;
        animation: pulse-green 2s infinite;
    }
    
    @keyframes pulse-green {
        0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
    }
    
    .username-title {
        background: var(--primary-gradient);
        background-clip: text;
        -webkit-background-clip: text;
        color: transparent;
        -webkit-text-fill-color: transparent;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .test-score-section {
        background: rgba(102, 126, 234, 0.05);
        border-radius: 15px;
        padding: 20px;
        margin: 20px 0;
    }
    
    .test-score-display {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        margin: 15px 0;
    }
    
    .score-circle {
        position: relative;
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: var(--primary-gradient);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .score-circle #total-score {
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1;
    }
    
    .score-circle .score-max {
        font-size: 0.8rem;
        opacity: 0.8;
        line-height: 1;
    }
    
    .pulse-btn {
        animation: pulse-button 3s infinite;
    }
    
    @keyframes pulse-button {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    /* Кастомные прогресс-бары */
    .personality-traits {
        background: rgba(255,255,255,0.7);
        border-radius: 15px;
        padding: 20px;
        backdrop-filter: blur(10px);
    }
    
    .trait-item {
        background: rgba(255,255,255,0.8);
        border-radius: 12px;
        padding: 15px;
        transition: all 0.3s ease;
        border: 1px solid rgba(255,255,255,0.2);
    }
    
    .trait-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        background: rgba(255,255,255,0.95);
    }
    
    .trait-label {
        margin: 0;
        font-size: 0.95rem;
        color: #333;
    }
    
    .trait-score {
        font-weight: bold;
        font-size: 1.1rem;
        background: var(--primary-gradient);
        background-clip: text;
        -webkit-background-clip: text;
        color: transparent;
        -webkit-text-fill-color: transparent;
    }
    
    .custom-progress {
        height: 12px;
        background: rgba(0,0,0,0.1);
        border-radius: 10px;
        overflow: hidden;
        position: relative;
    }
    
    .progress-fill {
        height: 100%;
        border-radius: 10px;
        transition: all 1s ease-in-out;
        position: relative;
        overflow: hidden;
    }
    
    .progress-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        animation: shine 2s infinite;
    }
    
    @keyframes shine {
        0% { left: -100%; }
        100% { left: 100%; }
    }
    
    .progress-fill.sociability {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .progress-fill.openness {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .progress-fill.emotionality {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .progress-fill.organization {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    
    .progress-fill.agreeableness {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    
    /* Модальное окно статистики */
    .stat-card {
        background: rgba(255,255,255,0.9);
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        margin-bottom: 20px;
        border: 1px solid rgba(102, 126, 234, 0.1);
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        border-color: rgba(102, 126, 234, 0.3);
    }
    
    .stat-icon {
        font-size: 2rem;
        margin-bottom: 10px;
        background: var(--primary-gradient);
        background-clip: text;
        -webkit-background-clip: text;
        color: transparent;
        -webkit-text-fill-color: transparent;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        margin: 0;
        color: #333;
    }
    
    .personality-radar {
        background: rgba(255,255,255,0.9);
        border-radius: 15px;
        padding: 20px;
        text-align: center;
    }
    
    /* Интересы */
    .interests-container {
        max-height: 300px;
        overflow-y: auto;
        padding: 15px;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        background: rgba(255,255,255,0.8);
        backdrop-filter: blur(10px);
    }
    
    .interest-item {
        padding: 8px;
        border-radius: 8px;
        transition: all 0.3s;
        border: 1px solid transparent;
        background: rgba(255,255,255,0.7);
        margin-bottom: 8px;
    }
    
    .interest-item:hover {
        background: #fff;
        border-color: #667eea;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .interest-item .form-check-input:checked + .form-check-label {
        color: #667eea;
        font-weight: 600;
    }
    
    .interest-item .form-check-label {
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 0;
    }

    /* Улучшения списка интересов */
    #interestsGrid .interest-item {
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(255,255,255,0.9);
    }
    #interestsGrid .interest-item input[type="checkbox"] {
        transform: scale(1.2);
    }
    #interestsGrid .interest-item .form-check-label {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* Слайдеры теста: лучше видимость на светлом фоне */
    .test-range {
        width: 100%;
        accent-color: #667eea; /* для современных браузеров */
    }
    .test-range:focus {
        outline: none;
    }
    /* Chrome / Safari */
    .test-range::-webkit-slider-runnable-track {
        height: 8px;
        background: #bfc3cf; /* более тёмный трек на белом */
        border-radius: 4px;
    }
    .test-range::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        margin-top: -5px; /* выравнивание по центру трека */
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: 2px solid #fff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.25);
    }
    .test-range:focus::-webkit-slider-thumb {
        box-shadow: 0 0 0 6px rgba(102, 126, 234, 0.25);
    }
    /* Firefox */
    .test-range::-moz-range-track {
        height: 8px;
        background: #bfc3cf;
        border-radius: 4px;
    }
    .test-range::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: 2px solid #fff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.25);
    }
</style>

<!-- Chart.js для радар-диаграммы -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Django данные для JavaScript -->
<div id="personality-data" 
     data-q1="{{ user.question1 }}" 
     data-q2="{{ user.question2 }}" 
     data-q3="{{ user.question3 }}" 
     data-q4="{{ user.question4 }}" 
     data-q5="{{ user.question5 }}" 
     style="display:none;"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('JavaScript загружен!');
    
    // Инициализация прогресс-баров
    initializeProgressBars();
    
    // Радар-чарт в модальном окне
    const modal = document.getElementById('profileStatsModal');
    modal.addEventListener('shown.bs.modal', function() {
        const ctx = document.getElementById('personalityChart').getContext('2d');
        
        if (window.personalityChart instanceof Chart) {
            window.personalityChart.destroy();
        }
        
        const dataEl = document.getElementById('personality-data');
        const chartData = [
            parseInt(dataEl.getAttribute('data-q1')),
            parseInt(dataEl.getAttribute('data-q2')),
            parseInt(dataEl.getAttribute('data-q3')),
            parseInt(dataEl.getAttribute('data-q4')),
            parseInt(dataEl.getAttribute('data-q5'))
        ];
        
        window.personalityChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['Общительность', 'Открытость', 'Эмоциональность', 'Организованность', 'Доброжелательность'],
                datasets: [{
                    label: 'Ваш профиль',
                    data: chartData,
                    backgroundColor: 'rgba(102, 126, 234, 0.2)',
                    borderColor: 'rgba(102, 126, 234, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 5,
                        min: 0,
                        stepSize: 1,
                        grid: { color: 'rgba(102, 126, 234, 0.1)' },
                        angleLines: { color: 'rgba(102, 126, 234, 0.2)' },
                        pointLabels: { font: { size: 12, weight: '600' }, color: '#333' },
                        ticks: { display: false }
                    }
                },
                plugins: { legend: { display: false } },
                animation: { duration: 1500, easing: 'easeInOutQuart' }
            }
        });
    });
    
    // Обновление в реальном времени при изменении теста
    // Слушатели для слайдеров теста
    const testRanges = document.querySelectorAll('.test-range');
    testRanges.forEach(function(range) {
        range.addEventListener('input', function() {
            const badge = document.getElementById('val_' + range.name);
            if (badge) badge.textContent = range.value;
            updateTestDisplay();
        });
    });
    
    function initializeProgressBars() {
        // Инициализируем ширину прогресс-баров из data-атрибутов
        for (let i = 1; i <= 5; i++) {
            const progressEl = document.getElementById('progress-' + i);
            if (progressEl) {
                const width = progressEl.getAttribute('data-width');
                progressEl.style.width = width + '%';
            }
        }
        
        // Инициализируем общий прогресс-бар
        const totalProgressEl = document.getElementById('total-progress');
        if (totalProgressEl) {
            const width = totalProgressEl.getAttribute('data-width');
            totalProgressEl.style.width = width + '%';
        }
    }
    
    function updateTestDisplay() {
        console.log('updateTestDisplay() вызвана');
        const values = [];
        for (let i = 1; i <= 5; i++) {
            const range = document.querySelector('input[name="question' + i + '"]');
            if (range && range.value) {
                values.push(parseInt(range.value));
            } else {
                return; // Ждём пока все 5 будут иметь значение
            }
        }
        console.log('Все значения:', values);
        
        // Обновляем счетчики
        values.forEach(function(value, index) {
            const scoreEl = document.getElementById('score-' + (index + 1));
            const progressEl = document.getElementById('progress-' + (index + 1));
            
            if (scoreEl) scoreEl.textContent = value + '/5';
            if (progressEl) progressEl.style.width = (value * 20) + '%';
        });
        
        // Обновляем общий балл
        const totalScore = values.reduce(function(sum, val) { return sum + val; }, 0);
        const totalScoreEl = document.getElementById('total-score');
        const totalProgressEl = document.getElementById('total-progress');
        const badgeEl = document.getElementById('personality-badge');
        
        if (totalScoreEl) totalScoreEl.textContent = totalScore;
        if (totalProgressEl) totalProgressEl.style.width = (totalScore * 4) + '%';
        
        if (badgeEl) {
            badgeEl.className = 'badge ';
            if (totalScore <= 10) {
                badgeEl.classList.add('bg-info');
                badgeEl.textContent = 'Интроверт';
            } else if (totalScore <= 15) {
                badgeEl.classList.add('bg-warning');
                badgeEl.textContent = 'Сбалансированный';
            } else if (totalScore <= 20) {
                badgeEl.classList.add('bg-success');
                badgeEl.textContent = 'Общительный';
            } else {
                badgeEl.classList.add('bg-primary');
                badgeEl.textContent = 'Экстраверт';
            }
        }
        
        // Обновляем радар-чарт если открыт
        if (window.personalityChart instanceof Chart) {
            window.personalityChart.data.datasets[0].data = values;
            window.personalityChart.update('active');
        }
    }
    
    // ===== Интерактив "Мои интересы" =====
    const interestsGrid = document.getElementById('interestsGrid');
    const interestSearch = document.getElementById('interestSearch');
    const btnSelectAll = document.getElementById('btnSelectAll');
    const btnClearAll = document.getElementById('btnClearAll');
    const selectedCountEl = document.getElementById('selectedCount');
    const saveInterestsBtn = document.getElementById('save-interests-btn');
    const filterBadge = document.getElementById('filterBadge');
    const filterText = document.getElementById('filterText');
    const interestsHelp = document.getElementById('interests-help');

    function recalcSelectedCount() {
        const checked = interestsGrid ? interestsGrid.querySelectorAll('.interest-item input[type="checkbox"]:checked').length : 0;
        if (selectedCountEl) selectedCountEl.textContent = checked;
        if (saveInterestsBtn) saveInterestsBtn.disabled = checked < 3;
        if (interestsHelp) interestsHelp.classList.toggle('text-danger', checked < 3);
    }

    function applyFilter(text) {
        const q = (text || '').trim().toLowerCase();
        const items = interestsGrid ? interestsGrid.querySelectorAll('.interest-filterable') : [];
        let visible = 0;
        items.forEach(el => {
            const name = el.getAttribute('data-name') || '';
            const match = !q || name.includes(q);
            el.parentElement.classList.toggle('d-none', !match);
            if (match) visible += 1;
        });
        if (filterBadge) filterBadge.classList.toggle('d-none', !q);
        if (filterText) filterText.textContent = q;
        return visible;
    }

    if (interestSearch) {
        interestSearch.addEventListener('input', () => applyFilter(interestSearch.value));
    }
    if (btnSelectAll) {
        btnSelectAll.addEventListener('click', () => {
            const boxes = interestsGrid ? interestsGrid.querySelectorAll('.interest-item input[type="checkbox"]') : [];
            boxes.forEach(b => b.checked = true);
            recalcSelectedCount();
        });
    }
    if (btnClearAll) {
        btnClearAll.addEventListener('click', () => {
            const boxes = interestsGrid ? interestsGrid.querySelectorAll('.interest-item input[type="checkbox"]') : [];
            boxes.forEach(b => b.checked = false);
            recalcSelectedCount();
        });
    }
    if (interestsGrid) {
        interestsGrid.addEventListener('change', (e) => {
            if (e.target && e.target.matches('input[type="checkbox"]')) {
                recalcSelectedCount();
            }
        });
        // Инициализация
        recalcSelectedCount();
    }

         // Функция для тестирования нового метода update_test_scores
     function testUpdateTestScores() {
         // Собираем реальные данные из формы
         const testData = {};
         for (let i = 1; i <= 5; i++) {
             const radio = document.querySelector(`input[name="question${i}"]:checked`);
             if (radio) {
                 testData[`q${i}`] = parseInt(radio.value);
             } else {
                 alert('Пожалуйста, ответьте на все вопросы перед тестированием!');
                 return;
             }
         }
         
         console.log('Отправляемые данные:', testData);
         
         fetch('/api/update-test-scores/', {
             method: 'POST',
             headers: {
                 'Content-Type': 'application/json',
                 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
             },
             body: JSON.stringify(testData)
         })
         .then(response => response.json())
         .then(data => {
             console.log('✅ Тест обновления баллов:', data);
             if (data.status === 'success') {
                 alert(`Баллы обновлены! Новый общий балл: ${data.new_score}`);
                 // Обновляем отображение на странице
                 location.reload();
             } else {
                 alert('Ошибка: ' + data.message);
             }
         })
         .catch(error => {
             console.error('❌ Ошибка при обновлении баллов:', error);
             alert('Ошибка при обновлении баллов');
         });
     }
    
         // Добавляем кнопку для тестирования (только для разработки)
     if (window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost') {
         const testButton = document.createElement('button');
         testButton.textContent = '🧪 Тест обновления баллов';
         testButton.className = 'btn btn-warning btn-sm mt-2';
         testButton.onclick = testUpdateTestScores;
         document.querySelector('.test-score-section').appendChild(testButton);
     }
     
     // Обработка отправки формы теста через API
     const testForm = document.getElementById('test-form');
     const saveTestBtn = document.getElementById('save-test-btn');
     const testSaveStatus = document.getElementById('test-save-status');
     
     if (testForm) {
         testForm.addEventListener('submit', function(event) {
             event.preventDefault();
             
              // Собираем значения всех пяти слайдеров
              const testData = {};
              for (let i = 1; i <= 5; i++) {
                  const el = document.querySelector(`input[name="question${i}"]`);
                  if (el && el.value) {
                      testData[`q${i}`] = parseInt(el.value);
                  } else {
                      testSaveStatus.innerHTML = '<div class="alert alert-danger">Пожалуйста, укажите значения для всех вопросов!</div>';
                      return;
                  }
              }
             
             // Показываем статус загрузки
             saveTestBtn.disabled = true;
             saveTestBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Сохранение...';
             testSaveStatus.innerHTML = '<div class="alert alert-info">Обновляем баллы теста...</div>';
             
                           // Отправляем данные через API
              console.log('📤 Отправляем данные:', testData);
              fetch('/api/update-test-scores/', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                  },
                  body: JSON.stringify(testData)
              })
             .then(response => response.json())
             .then(data => {
                 console.log('✅ Результат обновления теста:', data);
                 
                 if (data.status === 'success') {
                     testSaveStatus.innerHTML = '<div class="alert alert-success">✅ Баллы теста успешно обновлены! Новый общий балл: ' + data.new_score + '</div>';
                     
                     // Обновляем отображение на странице
                     setTimeout(() => {
                         location.reload();
                     }, 1500);
                 } else {
                     testSaveStatus.innerHTML = '<div class="alert alert-danger">❌ Ошибка: ' + data.message + '</div>';
                     saveTestBtn.disabled = false;
                     saveTestBtn.innerHTML = '<i class="fas fa-save"></i> Сохранить результаты';
                 }
             })
             .catch(error => {
                 console.error('❌ Ошибка при обновлении теста:', error);
                 testSaveStatus.innerHTML = '<div class="alert alert-danger">❌ Ошибка при обновлении баллов</div>';
                 saveTestBtn.disabled = false;
                 saveTestBtn.innerHTML = '<i class="fas fa-save"></i> Сохранить результаты';
             });
         });
     }
});
</script>
{% endblock %}