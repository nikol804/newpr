{% extends 'base.html' %}
{% load math_filters %}

{% block title %}–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç - MatchMaker{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-4">
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
        <div class="card mb-4 animate__animated animate__fadeInLeft profile-main-card">
            <div class="card-body text-center">
                <div class="mb-3 profile-avatar">
                    <div class="avatar-wrapper">
                        <i class="fas fa-user-circle" style="font-size: 5rem; color: #667eea;"></i>
                        <div class="status-indicator online"></div>
                    </div>
                </div>
                <h3 class="username-title">{{ user.username }}</h3>
                <p class="text-muted mb-1">{{ user.email }}</p>
                {% if user.social_url %}
                <p class="mb-2">
                    <a href="{{ user.social_url }}" target="_blank" rel="noopener" class="btn btn-sm btn-outline-primary">
                        <i class="fab fa-vk"></i> –ü—Ä–æ—Ñ–∏–ª—å –≤ —Å–æ—Ü—Å–µ—Ç–∏
                    </a>
                </p>
                {% endif %}
                <small class="text-muted">
                    <i class="fas fa-calendar-alt"></i> 
                    –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: {{ user.created_at|date:"d.m.Y" }}
                </small>
                
                <div class="mt-4 test-score-section">
                    <h5><i class="fas fa-brain me-2"></i>–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å</h5>
                    <div class="test-score-display">
                        <div class="score-circle">
                            <span id="total-score">{{ test_score }}</span>
                            <span class="score-max">/25</span>
                        </div>
                        <div class="score-description">
                            <span id="personality-badge" class="badge 
                                {% if test_score <= 10 %}bg-info{% elif test_score <= 15 %}bg-warning{% elif test_score <= 20 %}bg-success{% else %}bg-primary{% endif %}">
                                {% if test_score <= 10 %}–ò–Ω—Ç—Ä–æ–≤–µ—Ä—Ç{% elif test_score <= 15 %}–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π{% elif test_score <= 20 %}–û–±—â–∏—Ç–µ–ª—å–Ω—ã–π{% else %}–≠–∫—Å—Ç—Ä–∞–≤–µ—Ä—Ç{% endif %}
                            </span>
                        </div>
                    </div>
                    <div class="progress mt-3" style="height: 12px;">
                        <div id="total-progress" class="progress-bar progress-bar-animated" role="progressbar" 
                             data-width="{{ test_score|mul:4 }}" style="background: var(--primary-gradient);">
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 d-grid gap-2">
                    <a href="{% url 'search' %}" class="btn btn-gradient btn-lg pulse-btn">
                        <i class="fas fa-search"></i> –ù–∞–π—Ç–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
                    </a>
                    <button class="btn btn-outline-secondary btn-sm" 
                            data-bs-toggle="modal" data-bs-target="#profileStatsModal">
                        <i class="fas fa-chart-pie"></i> –ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                    </button>
                </div>
            </div>
        </div>
        
        <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —á–∞—Ç—ã -->
        {% if chats %}
        <div class="card animate__animated animate__fadeInLeft">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-comments"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–µ —á–∞—Ç—ã</h5>
            </div>
            <div class="list-group list-group-flush">
                {% for chat in chats %}
                <a href="{% url 'chat' chat.id %}" class="list-group-item list-group-item-action">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ chat.get_other_user.username }}</strong>
                            <small class="text-muted d-block">
                                {{ chat.created_at|date:"d.m.Y H:i" }}
                            </small>
                        </div>
                        <i class="fas fa-chevron-right text-muted"></i>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="col-md-8">
        <!-- –ò–Ω—Ç–µ—Ä–µ—Å—ã -->
        <div class="card mb-4 animate__animated animate__fadeInRight">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-heart"></i> –ú–æ–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    {% for interest in user.interests.all %}
                    <span class="interest-badge">
                        <i class="{{ interest.icon }}"></i> {{ interest.name }}
                    </span>
                    {% empty %}
                    <p class="text-muted">–ò–Ω—Ç–µ—Ä–µ—Å—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</p>
                    {% endfor %}
                </div>
                
                <!-- –§–æ—Ä–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ -->
                <button class="btn btn-sm btn-secondary-gradient" 
                        data-bs-toggle="collapse" data-bs-target="#updateInterests">
                    <i class="fas fa-edit"></i> –ò–∑–º–µ–Ω–∏—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å—ã
                </button>
                
                <div class="collapse mt-3" id="updateInterests">
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="update_interests" value="1">

                        <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏ -->
                        <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
                            <div class="input-group" style="max-width: 360px;">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input id="interestSearch" type="search" class="form-control" placeholder="–ü–æ–∏—Å–∫ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤">
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnSelectAll">
                                <i class="fas fa-check-double"></i> –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnClearAll">
                                <i class="fas fa-eraser"></i> –°–±—Ä–æ—Å–∏—Ç—å
                            </button>
                            <div class="ms-auto d-flex align-items-center gap-2">
                                <span class="badge bg-primary">–í—ã–±—Ä–∞–Ω–æ: <span id="selectedCount">0</span></span>
                                <span class="badge bg-secondary d-none" id="filterBadge">–§–∏–ª—å—Ç—Ä: <span id="filterText"></span></span>
                            </div>
                        </div>

                        <div class="interests-container mb-3" id="interestsGrid">
                            <div class="row">
                                {% for choice in form.interests %}
                                <div class="col-md-6 col-lg-4 mb-2">
                                    <div class="form-check interest-item interest-filterable" data-name="{{ choice.choice_label|lower }}">
                                        {{ choice.tag }}
                                        <label class="form-check-label w-100" for="{{ choice.id_for_label }}">
                                            <i class="fas fa-star me-2"></i>{{ choice.choice_label }}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        

                        
                        <button type="submit" class="btn btn-gradient" id="save-interests-btn" disabled>
                            <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å—ã
                        </button>
                        <small class="text-muted ms-2" id="interests-help">–í—ã–±–µ—Ä–∏—Ç–µ –º–∏–Ω–∏–º—É–º 3 –∏–Ω—Ç–µ—Ä–µ—Å–∞</small>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç -->
        <div class="card animate__animated animate__fadeInRight">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-brain"></i> –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å</h5>
            </div>
            <div class="card-body">
                <div class="personality-traits">
                    <div class="trait-item mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="trait-label">
                                <i class="fas fa-users text-primary me-2"></i>
                                <span class="fw-bold">–û–±—â–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</span>
                            </label>
                            <span id="score-1" class="trait-score">{{ user.question1 }}/5</span>
                        </div>
                        <div class="custom-progress">
                            <div id="progress-1" class="progress-fill sociability" 
                                 data-width="{{ user.question1|mul:20 }}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="trait-item mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="trait-label">
                                <i class="fas fa-lightbulb text-warning me-2"></i>
                                <span class="fw-bold">–û—Ç–∫—Ä—ã—Ç–æ—Å—Ç—å –Ω–æ–≤–æ–º—É</span>
                            </label>
                            <span id="score-2" class="trait-score">{{ user.question2 }}/5</span>
                        </div>
                        <div class="custom-progress">
                            <div id="progress-2" class="progress-fill openness" 
                                 data-width="{{ user.question2|mul:20 }}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="trait-item mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="trait-label">
                                <i class="fas fa-heart text-danger me-2"></i>
                                <span class="fw-bold">–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å</span>
                            </label>
                            <span id="score-3" class="trait-score">{{ user.question3 }}/5</span>
                        </div>
                        <div class="custom-progress">
                            <div id="progress-3" class="progress-fill emotionality" 
                                 data-width="{{ user.question3|mul:20 }}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="trait-item mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="trait-label">
                                <i class="fas fa-tasks text-success me-2"></i>
                                <span class="fw-bold">–û—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω–æ—Å—Ç—å</span>
                            </label>
                            <span id="score-4" class="trait-score">{{ user.question4 }}/5</span>
                        </div>
                        <div class="custom-progress">
                            <div id="progress-4" class="progress-fill organization" 
                                 data-width="{{ user.question4|mul:20 }}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="trait-item mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="trait-label">
                                <i class="fas fa-handshake text-info me-2"></i>
                                <span class="fw-bold">–î–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å</span>
                            </label>
                            <span id="score-5" class="trait-score">{{ user.question5 }}/5</span>
                        </div>
                        <div class="custom-progress">
                            <div id="progress-5" class="progress-fill agreeableness" 
                                 data-width="{{ user.question5|mul:20 }}">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- –§–æ—Ä–º–∞ –ø–µ—Ä–µ–ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–∞ -->
                <button class="btn btn-sm btn-secondary-gradient mt-3" 
                        data-bs-toggle="collapse" data-bs-target="#retakeTest">
                    <i class="fas fa-redo"></i> –ü–µ—Ä–µ–ø—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç
                </button>
                
                 <div class="collapse mt-3" id="retakeTest">
                     <form id="test-form" method="post">
                         {% csrf_token %}
                         <input type="hidden" name="update_test" value="1">
                         
                         <div class="test-questions">
                             {% for field in test_form %}
                             <div class="mb-4">
                                 <label class="form-label fw-bold" for="{{ field.id_for_label }}">
                                     {{ field.label }}
                                     <span class="badge bg-primary ms-2" id="val_{{ field.name }}">{{ field.value|default:3 }}</span>
                                 </label>
                                 <small class="text-muted d-block mb-2">{{ field.help_text }}</small>
                                 {{ field }}
                             </div>
                             {% endfor %}
                         </div>
                         
                         <button type="submit" class="btn btn-gradient" id="save-test-btn">
                             <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                         </button>
                         <div id="test-save-status" class="mt-2"></div>
                     </form>
                 </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π -->
<div class="modal fade" id="profileStatsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-pie me-2"></i>–ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="stat-card">
                            <i class="fas fa-calendar-check stat-icon"></i>
                            <h6>–î–Ω–µ–π —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</h6>
                            <p class="stat-value">{{ user.created_at|timesince }}</p>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="stat-card">
                            <i class="fas fa-heart stat-icon"></i>
                            <h6>–ò–Ω—Ç–µ—Ä–µ—Å–æ–≤ –≤—ã–±—Ä–∞–Ω–æ</h6>
                            <p class="stat-value">{{ user.interests.count }}</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="stat-card">
                            <i class="fas fa-trophy stat-icon"></i>
                            <h6>–ë–∞–ª–ª —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏</h6>
                            <p class="stat-value">{{ test_score|mul:4 }}%</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6><i class="fas fa-chart-bar me-2"></i>–õ–∏—á–Ω–æ—Å—Ç–Ω—ã–µ —á–µ—Ä—Ç—ã</h6>
                    <div class="personality-radar">
                        <canvas id="personalityChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* –ü—Ä–æ—Ñ–∏–ª—å –∫–∞—Ä—Ç–æ—á–∫–∞ */
    .profile-main-card {
        background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.95) 100%);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.18);
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }
    
    .avatar-wrapper {
        position: relative;
        display: inline-block;
    }
    
    .status-indicator {
        position: absolute;
        bottom: 10px;
        right: 10px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 3px solid white;
    }
    
    .status-indicator.online {
        background: #28a745;
        animation: pulse-green 2s infinite;
    }
    
    @keyframes pulse-green {
        0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
    }
    
    .username-title {
        background: var(--primary-gradient);
        background-clip: text;
        -webkit-background-clip: text;
        color: transparent;
        -webkit-text-fill-color: transparent;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .test-score-section {
        background: rgba(102, 126, 234, 0.05);
        border-radius: 15px;
        padding: 20px;
        margin: 20px 0;
    }
    
    .test-score-display {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        margin: 15px 0;
    }
    
    .score-circle {
        position: relative;
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: var(--primary-gradient);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .score-circle #total-score {
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1;
    }
    
    .score-circle .score-max {
        font-size: 0.8rem;
        opacity: 0.8;
        line-height: 1;
    }
    
    .pulse-btn {
        animation: pulse-button 3s infinite;
    }
    
    @keyframes pulse-button {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    /* –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã */
    .personality-traits {
        background: rgba(255,255,255,0.7);
        border-radius: 15px;
        padding: 20px;
        backdrop-filter: blur(10px);
    }
    
    .trait-item {
        background: rgba(255,255,255,0.8);
        border-radius: 12px;
        padding: 15px;
        transition: all 0.3s ease;
        border: 1px solid rgba(255,255,255,0.2);
    }
    
    .trait-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        background: rgba(255,255,255,0.95);
    }
    
    .trait-label {
        margin: 0;
        font-size: 0.95rem;
        color: #333;
    }
    
    .trait-score {
        font-weight: bold;
        font-size: 1.1rem;
        background: var(--primary-gradient);
        background-clip: text;
        -webkit-background-clip: text;
        color: transparent;
        -webkit-text-fill-color: transparent;
    }
    
    .custom-progress {
        height: 12px;
        background: rgba(0,0,0,0.1);
        border-radius: 10px;
        overflow: hidden;
        position: relative;
    }
    
    .progress-fill {
        height: 100%;
        border-radius: 10px;
        transition: all 1s ease-in-out;
        position: relative;
        overflow: hidden;
    }
    
    .progress-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        animation: shine 2s infinite;
    }
    
    @keyframes shine {
        0% { left: -100%; }
        100% { left: 100%; }
    }
    
    .progress-fill.sociability {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .progress-fill.openness {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .progress-fill.emotionality {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .progress-fill.organization {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    
    .progress-fill.agreeableness {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    
    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
    .stat-card {
        background: rgba(255,255,255,0.9);
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        margin-bottom: 20px;
        border: 1px solid rgba(102, 126, 234, 0.1);
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        border-color: rgba(102, 126, 234, 0.3);
    }
    
    .stat-icon {
        font-size: 2rem;
        margin-bottom: 10px;
        background: var(--primary-gradient);
        background-clip: text;
        -webkit-background-clip: text;
        color: transparent;
        -webkit-text-fill-color: transparent;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        margin: 0;
        color: #333;
    }
    
    .personality-radar {
        background: rgba(255,255,255,0.9);
        border-radius: 15px;
        padding: 20px;
        text-align: center;
    }
    
    /* –ò–Ω—Ç–µ—Ä–µ—Å—ã */
    .interests-container {
        max-height: 300px;
        overflow-y: auto;
        padding: 15px;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        background: rgba(255,255,255,0.8);
        backdrop-filter: blur(10px);
    }
    
    .interest-item {
        padding: 8px;
        border-radius: 8px;
        transition: all 0.3s;
        border: 1px solid transparent;
        background: rgba(255,255,255,0.7);
        margin-bottom: 8px;
    }
    
    .interest-item:hover {
        background: #fff;
        border-color: #667eea;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .interest-item .form-check-input:checked + .form-check-label {
        color: #667eea;
        font-weight: 600;
    }
    
    .interest-item .form-check-label {
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 0;
    }

    /* –£–ª—É—á—à–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ */
    #interestsGrid .interest-item {
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(255,255,255,0.9);
    }
    #interestsGrid .interest-item input[type="checkbox"] {
        transform: scale(1.2);
    }
    #interestsGrid .interest-item .form-check-label {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* –°–ª–∞–π–¥–µ—Ä—ã —Ç–µ—Å—Ç–∞: –ª—É—á—à–µ –≤–∏–¥–∏–º–æ—Å—Ç—å –Ω–∞ —Å–≤–µ—Ç–ª–æ–º —Ñ–æ–Ω–µ */
    .test-range {
        width: 100%;
        accent-color: #667eea; /* –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ */
    }
    .test-range:focus {
        outline: none;
    }
    /* Chrome / Safari */
    .test-range::-webkit-slider-runnable-track {
        height: 8px;
        background: #bfc3cf; /* –±–æ–ª–µ–µ —Ç—ë–º–Ω—ã–π —Ç—Ä–µ–∫ –Ω–∞ –±–µ–ª–æ–º */
        border-radius: 4px;
    }
    .test-range::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        margin-top: -5px; /* –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É —Ç—Ä–µ–∫–∞ */
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: 2px solid #fff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.25);
    }
    .test-range:focus::-webkit-slider-thumb {
        box-shadow: 0 0 0 6px rgba(102, 126, 234, 0.25);
    }
    /* Firefox */
    .test-range::-moz-range-track {
        height: 8px;
        background: #bfc3cf;
        border-radius: 4px;
    }
    .test-range::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: 2px solid #fff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.25);
    }
</style>

<!-- Chart.js –¥–ª—è —Ä–∞–¥–∞—Ä-–¥–∏–∞–≥—Ä–∞–º–º—ã -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Django –¥–∞–Ω–Ω—ã–µ –¥–ª—è JavaScript -->
<div id="personality-data" 
     data-q1="{{ user.question1 }}" 
     data-q2="{{ user.question2 }}" 
     data-q3="{{ user.question3 }}" 
     data-q4="{{ user.question4 }}" 
     data-q5="{{ user.question5 }}" 
     style="display:none;"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('JavaScript –∑–∞–≥—Ä—É–∂–µ–Ω!');
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–≤
    initializeProgressBars();
    
    // –†–∞–¥–∞—Ä-—á–∞—Ä—Ç –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    const modal = document.getElementById('profileStatsModal');
    modal.addEventListener('shown.bs.modal', function() {
        const ctx = document.getElementById('personalityChart').getContext('2d');
        
        if (window.personalityChart instanceof Chart) {
            window.personalityChart.destroy();
        }
        
        const dataEl = document.getElementById('personality-data');
        const chartData = [
            parseInt(dataEl.getAttribute('data-q1')),
            parseInt(dataEl.getAttribute('data-q2')),
            parseInt(dataEl.getAttribute('data-q3')),
            parseInt(dataEl.getAttribute('data-q4')),
            parseInt(dataEl.getAttribute('data-q5'))
        ];
        
        window.personalityChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['–û–±—â–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å', '–û—Ç–∫—Ä—ã—Ç–æ—Å—Ç—å', '–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å', '–û—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω–æ—Å—Ç—å', '–î–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å'],
                datasets: [{
                    label: '–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å',
                    data: chartData,
                    backgroundColor: 'rgba(102, 126, 234, 0.2)',
                    borderColor: 'rgba(102, 126, 234, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 5,
                        min: 0,
                        stepSize: 1,
                        grid: { color: 'rgba(102, 126, 234, 0.1)' },
                        angleLines: { color: 'rgba(102, 126, 234, 0.2)' },
                        pointLabels: { font: { size: 12, weight: '600' }, color: '#333' },
                        ticks: { display: false }
                    }
                },
                plugins: { legend: { display: false } },
                animation: { duration: 1500, easing: 'easeInOutQuart' }
            }
        });
    });
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–µ—Å—Ç–∞
    // –°–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è —Å–ª–∞–π–¥–µ—Ä–æ–≤ —Ç–µ—Å—Ç–∞
    const testRanges = document.querySelectorAll('.test-range');
    testRanges.forEach(function(range) {
        range.addEventListener('input', function() {
            const badge = document.getElementById('val_' + range.name);
            if (badge) badge.textContent = range.value;
            updateTestDisplay();
        });
    });
    
    function initializeProgressBars() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —à–∏—Ä–∏–Ω—É –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–≤ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–æ–≤
        for (let i = 1; i <= 5; i++) {
            const progressEl = document.getElementById('progress-' + i);
            if (progressEl) {
                const width = progressEl.getAttribute('data-width');
                progressEl.style.width = width + '%';
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
        const totalProgressEl = document.getElementById('total-progress');
        if (totalProgressEl) {
            const width = totalProgressEl.getAttribute('data-width');
            totalProgressEl.style.width = width + '%';
        }
    }
    
    function updateTestDisplay() {
        console.log('updateTestDisplay() –≤—ã–∑–≤–∞–Ω–∞');
        const values = [];
        for (let i = 1; i <= 5; i++) {
            const range = document.querySelector('input[name="question' + i + '"]');
            if (range && range.value) {
                values.push(parseInt(range.value));
            } else {
                return; // –ñ–¥—ë–º –ø–æ–∫–∞ –≤—Å–µ 5 –±—É–¥—É—Ç –∏–º–µ—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ
            }
        }
        console.log('–í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è:', values);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
        values.forEach(function(value, index) {
            const scoreEl = document.getElementById('score-' + (index + 1));
            const progressEl = document.getElementById('progress-' + (index + 1));
            
            if (scoreEl) scoreEl.textContent = value + '/5';
            if (progressEl) progressEl.style.width = (value * 20) + '%';
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π –±–∞–ª–ª
        const totalScore = values.reduce(function(sum, val) { return sum + val; }, 0);
        const totalScoreEl = document.getElementById('total-score');
        const totalProgressEl = document.getElementById('total-progress');
        const badgeEl = document.getElementById('personality-badge');
        
        if (totalScoreEl) totalScoreEl.textContent = totalScore;
        if (totalProgressEl) totalProgressEl.style.width = (totalScore * 4) + '%';
        
        if (badgeEl) {
            badgeEl.className = 'badge ';
            if (totalScore <= 10) {
                badgeEl.classList.add('bg-info');
                badgeEl.textContent = '–ò–Ω—Ç—Ä–æ–≤–µ—Ä—Ç';
            } else if (totalScore <= 15) {
                badgeEl.classList.add('bg-warning');
                badgeEl.textContent = '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π';
            } else if (totalScore <= 20) {
                badgeEl.classList.add('bg-success');
                badgeEl.textContent = '–û–±—â–∏—Ç–µ–ª—å–Ω—ã–π';
            } else {
                badgeEl.classList.add('bg-primary');
                badgeEl.textContent = '–≠–∫—Å—Ç—Ä–∞–≤–µ—Ä—Ç';
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–¥–∞—Ä-—á–∞—Ä—Ç –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç
        if (window.personalityChart instanceof Chart) {
            window.personalityChart.data.datasets[0].data = values;
            window.personalityChart.update('active');
        }
    }
    
    // ===== –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤ "–ú–æ–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã" =====
    const interestsGrid = document.getElementById('interestsGrid');
    const interestSearch = document.getElementById('interestSearch');
    const btnSelectAll = document.getElementById('btnSelectAll');
    const btnClearAll = document.getElementById('btnClearAll');
    const selectedCountEl = document.getElementById('selectedCount');
    const saveInterestsBtn = document.getElementById('save-interests-btn');
    const filterBadge = document.getElementById('filterBadge');
    const filterText = document.getElementById('filterText');
    const interestsHelp = document.getElementById('interests-help');

    function recalcSelectedCount() {
        const checked = interestsGrid ? interestsGrid.querySelectorAll('.interest-item input[type="checkbox"]:checked').length : 0;
        if (selectedCountEl) selectedCountEl.textContent = checked;
        if (saveInterestsBtn) saveInterestsBtn.disabled = checked < 3;
        if (interestsHelp) interestsHelp.classList.toggle('text-danger', checked < 3);
    }

    function applyFilter(text) {
        const q = (text || '').trim().toLowerCase();
        const items = interestsGrid ? interestsGrid.querySelectorAll('.interest-filterable') : [];
        let visible = 0;
        items.forEach(el => {
            const name = el.getAttribute('data-name') || '';
            const match = !q || name.includes(q);
            el.parentElement.classList.toggle('d-none', !match);
            if (match) visible += 1;
        });
        if (filterBadge) filterBadge.classList.toggle('d-none', !q);
        if (filterText) filterText.textContent = q;
        return visible;
    }

    if (interestSearch) {
        interestSearch.addEventListener('input', () => applyFilter(interestSearch.value));
    }
    if (btnSelectAll) {
        btnSelectAll.addEventListener('click', () => {
            const boxes = interestsGrid ? interestsGrid.querySelectorAll('.interest-item input[type="checkbox"]') : [];
            boxes.forEach(b => b.checked = true);
            recalcSelectedCount();
        });
    }
    if (btnClearAll) {
        btnClearAll.addEventListener('click', () => {
            const boxes = interestsGrid ? interestsGrid.querySelectorAll('.interest-item input[type="checkbox"]') : [];
            boxes.forEach(b => b.checked = false);
            recalcSelectedCount();
        });
    }
    if (interestsGrid) {
        interestsGrid.addEventListener('change', (e) => {
            if (e.target && e.target.matches('input[type="checkbox"]')) {
                recalcSelectedCount();
            }
        });
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        recalcSelectedCount();
    }

         // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –º–µ—Ç–æ–¥–∞ update_test_scores
     function testUpdateTestScores() {
         // –°–æ–±–∏—Ä–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
         const testData = {};
         for (let i = 1; i <= 5; i++) {
             const radio = document.querySelector(`input[name="question${i}"]:checked`);
             if (radio) {
                 testData[`q${i}`] = parseInt(radio.value);
             } else {
                 alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º!');
                 return;
             }
         }
         
         console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:', testData);
         
         fetch('/api/update-test-scores/', {
             method: 'POST',
             headers: {
                 'Content-Type': 'application/json',
                 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
             },
             body: JSON.stringify(testData)
         })
         .then(response => response.json())
         .then(data => {
             console.log('‚úÖ –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤:', data);
             if (data.status === 'success') {
                 alert(`–ë–∞–ª–ª—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã! –ù–æ–≤—ã–π –æ–±—â–∏–π –±–∞–ª–ª: ${data.new_score}`);
                 // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                 location.reload();
             } else {
                 alert('–û—à–∏–±–∫–∞: ' + data.message);
             }
         })
         .catch(error => {
             console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–∞–ª–ª–æ–≤:', error);
             alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–∞–ª–ª–æ–≤');
         });
     }
    
         // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
     if (window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost') {
         const testButton = document.createElement('button');
         testButton.textContent = 'üß™ –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤';
         testButton.className = 'btn btn-warning btn-sm mt-2';
         testButton.onclick = testUpdateTestScores;
         document.querySelector('.test-score-section').appendChild(testButton);
     }
     
     // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —Ç–µ—Å—Ç–∞ —á–µ—Ä–µ–∑ API
     const testForm = document.getElementById('test-form');
     const saveTestBtn = document.getElementById('save-test-btn');
     const testSaveStatus = document.getElementById('test-save-status');
     
     if (testForm) {
         testForm.addEventListener('submit', function(event) {
             event.preventDefault();
             
              // –°–æ–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤—Å–µ—Ö –ø—è—Ç–∏ —Å–ª–∞–π–¥–µ—Ä–æ–≤
              const testData = {};
              for (let i = 1; i <= 5; i++) {
                  const el = document.querySelector(`input[name="question${i}"]`);
                  if (el && el.value) {
                      testData[`q${i}`] = parseInt(el.value);
                  } else {
                      testSaveStatus.innerHTML = '<div class="alert alert-danger">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö –≤–æ–ø—Ä–æ—Å–æ–≤!</div>';
                      return;
                  }
              }
             
             // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏
             saveTestBtn.disabled = true;
             saveTestBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
             testSaveStatus.innerHTML = '<div class="alert alert-info">–û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–ª—ã —Ç–µ—Å—Ç–∞...</div>';
             
                           // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ API
              console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ:', testData);
              fetch('/api/update-test-scores/', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                  },
                  body: JSON.stringify(testData)
              })
             .then(response => response.json())
             .then(data => {
                 console.log('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–∞:', data);
                 
                 if (data.status === 'success') {
                     testSaveStatus.innerHTML = '<div class="alert alert-success">‚úÖ –ë–∞–ª–ª—ã —Ç–µ—Å—Ç–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã! –ù–æ–≤—ã–π –æ–±—â–∏–π –±–∞–ª–ª: ' + data.new_score + '</div>';
                     
                     // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                     setTimeout(() => {
                         location.reload();
                     }, 1500);
                 } else {
                     testSaveStatus.innerHTML = '<div class="alert alert-danger">‚ùå –û—à–∏–±–∫–∞: ' + data.message + '</div>';
                     saveTestBtn.disabled = false;
                     saveTestBtn.innerHTML = '<i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã';
                 }
             })
             .catch(error => {
                 console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–µ—Å—Ç–∞:', error);
                 testSaveStatus.innerHTML = '<div class="alert alert-danger">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–∞–ª–ª–æ–≤</div>';
                 saveTestBtn.disabled = false;
                 saveTestBtn.innerHTML = '<i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã';
             });
         });
     }
});
</script>
{% endblock %}